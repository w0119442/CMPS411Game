<html>
<head>
<!--	<link rel="stylesheet" type="text/css" href="canvasStyle.css" /> -->
<style>
button {
	width: 50px;
	height: 35px;
}
</style>
</head>
<body>
	<div id="themeDiv">
		<button id="tankTheme">Tank</button>
	</div>
	
	<canvas id="ctx"></canvas>
	<canvas id="worldMap" width="3000" height="3000" style="display:none;"></canvas>
	
	<script src="https://cdn.socket.io/socket.io-1.4.8.js"></script>
</body>

<script>
	var clientWidth = window.innerWidth;
	var clientHeight = window.innerHeight;
	var BUTTON_HEIGHT = 35;
	var WORLD_WIDTH = 1000;
	var WORLD_HEIGHT = 1000;
	var MAP_WRAP_NUMBER = 3;
	var BORDER_SIZE = 32;
	// Alter Viewport so the border fits nicely
	var VIEW_WIDTH = Math.floor(clientWidth * .9 / BORDER_SIZE) * BORDER_SIZE;
	var VIEW_HEIGHT = Math.floor(clientHeight * .9 / BORDER_SIZE) * BORDER_SIZE;
	var PLAYER_SIZE = 50;
	var HP = 3;
	
	var PLAYER_LIST = {};
	var socket = io();

	// theme selections
	var themeDiv = document.getElementById('themeDiv');
	var tankTheme = document.getElementById('tankTheme');
	
	var Img = {};
	Img.playerTop = new Image();
	Img.playerBase = new Image();
	Img.projectile = new Image();
	Img.map = new Image();
	Img.bgtile = new Image();
	
	// Default tank theme
	Img.playerTop.src = '/client/img/Tank/playerTop.png';
	Img.playerBase.src = '/client/img/Tank/playerBase.png';
	Img.projectile.src = '/client/img/Tank/bullet.png';
	Img.map.src = '/client/img/Tank/map.png';
	Img.bgtile.src = '/client/img/Tank/bgtile.png';
	var hpColor = "#00ff99";
	
	<!--
	/*
	tankTheme.onclick = function() {
		Img.projectile.src = '/client/img/tank/bullet.png';
		Img.map.src = '/client/img/tank/map.png';
	}
	*/
	-->
	
	var worldMapCanvas = document.getElementById("worldMap");
	var worldMap = worldMapCanvas.getContext("2d");
	Img.map.onload = function() {
		var patrn = worldMap.createPattern(Img.map, "repeat");
		worldMap.fillStyle = patrn;
		worldMap.fillRect(0, 0, worldMapCanvas.width, worldMapCanvas.height);
	}
	
	// game area
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.canvas.width = VIEW_WIDTH;
	ctx.canvas.height = VIEW_HEIGHT;
	Img.bgtile.onload = function() {
		var patrnBack = ctx.createPattern(Img.bgtile, "repeat");
		ctx.fillStyle = patrnBack;
		ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	}
	// These next two lines were an attempt to center the viewPort in the browser (not working)
	//ctx.canvas.style.top = (clientHeight-VIEW_HEIGHT)/2+"px";
	//ctx.canvas.style.left = (clientWidth-VIEW_WIDTH)/2+"px";
	ctx.font = '30px Arial';
	
	var clientId = null;
	
	socket.on('init',function(data) {
		if(data.selfId) {
			clientId = data.selfId;
		}
	});
	
	var pCenterX = 0.0;
	var pCenterY = 0.0;
	var pOffsetX = 0.0;
	var pOffsetY = 0.0;
	
	socket.on('newPositions',function(data) {

		ctx.clearRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
		var patrnBack = ctx.createPattern(Img.bgtile, "repeat");
		ctx.fillStyle = patrnBack;
		ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	
		for(var i = 0; i < data.player.length; i++) {
			if(data.player[i].id == clientId) {
				var playerX = data.player[i].x;
				var playerY = data.player[i].y;
				pCenterX = playerX + PLAYER_SIZE/2;
				pCenterY = playerY + PLAYER_SIZE/2;
				var xPosImage = 0.0;
				var yPosImage = 0.0;
				var clipX = pCenterX - VIEW_WIDTH/2;
				var clipY = pCenterY - VIEW_HEIGHT/2;
				pOffsetX = VIEW_WIDTH/2;
				pOffsetY = VIEW_HEIGHT/2;
				
				if(pCenterX  < VIEW_WIDTH/2) {
					clipX = 0;
					pOffsetX = pCenterX;
					xPosImage = Math.min(32, Math.abs(VIEW_WIDTH/2 - pCenterX));
				}
				else if(pCenterX  > WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH/2) {
					var borderSpot = WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH/2;
					clipX = WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH + Math.min(32, Math.abs(borderSpot - pCenterX));
					pOffsetX = VIEW_WIDTH - (WORLD_WIDTH * MAP_WRAP_NUMBER - pCenterX);
					xPosImage = 0;
				}
				
				if(pCenterY  < VIEW_HEIGHT/2) {
					clipY = 0;
					pOffsetY = pCenterY;
					yPosImage = Math.min(32, Math.abs(VIEW_HEIGHT/2 - pCenterY));
				}
				else if(pCenterY  > WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT/2) {
					var borderSpot = WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT/2;
					clipY = WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT + Math.min(32, Math.abs(borderSpot - pCenterY));
					pOffsetY = VIEW_HEIGHT - (WORLD_HEIGHT * MAP_WRAP_NUMBER - pCenterY);
					yPosImage = 0;
				}

				//drawImage(image, clipX, clipY, clipWidth, clipHeight, xPos, yPos, imageWidth, imageHeight)
				ctx.drawImage(worldMapCanvas, clipX, clipY, VIEW_WIDTH, VIEW_HEIGHT, xPosImage, yPosImage, VIEW_WIDTH, VIEW_HEIGHT);
				break;
			}
		}
		
		for(var i = 0; i < data.projectile.length; i++) {
			var projX = data.projectile[i].x - pCenterX + pOffsetX - 5;
			var projY = data.projectile[i].y - pCenterY + pOffsetY - 5;
			ctx.drawImage(Img.projectile, projX, projY, 10, 10);
		}

		for(var i = 0; i < data.player.length; i++) {
			if(data.player[i].id == clientId && data.player[i].alive) {
				// Drawing an HP bar
				var bottomX = pOffsetX - PLAYER_SIZE/2;
				var bottomY = pOffsetY + PLAYER_SIZE/2;
				var hpHeight = 7;
				var hpWidth = Math.floor(PLAYER_SIZE/HP);
				for(var j = 0; j < data.player[i].hp; j++) {
					ctx.fillStyle = hpColor;
					ctx.fillRect(bottomX + hpWidth * j, bottomY, hpWidth, hpHeight);
					ctx.strokeStyle = "#000000";
					ctx.lineWidth = 1;
					ctx.strokeRect(bottomX, bottomY, HP * hpWidth, hpHeight);
				}
				
				// Draw kill count (temp / test)
				var killCount = ""+data.player[i].playerKills;
				ctx.fillText(killCount, pOffsetX + 25, pOffsetY -5);
			
				// Draw the player base and player top
				ctx.save();
				ctx.translate(pOffsetX, pOffsetY);
				ctx.rotate(data.player[i].directAngle * Math.PI/180);
				ctx.drawImage(Img.playerBase, -PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);
				ctx.restore();
				ctx.save();
				ctx.translate(pOffsetX, pOffsetY);
				ctx.rotate((data.player[i].mouseAngle + 90)* Math.PI/180);
				ctx.drawImage(Img.playerTop, -PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);
				ctx.restore();
			}
			else if(Math.abs(pCenterX - data.player[i].x) < VIEW_WIDTH && Math.abs(pCenterY - data.player[i].y) < VIEW_HEIGHT && data.player[i].alive) {
				var otherX = data.player[i].x - pCenterX + pOffsetX;
				var otherY = data.player[i].y - pCenterY + pOffsetY;
				
				// Drawing an HP bar
				var bottomX = otherX;
				var bottomY = otherY + PLAYER_SIZE;
				var hpHeight = 7;
				var hpWidth = Math.floor(PLAYER_SIZE/HP);
				for(var j = 0; j < data.player[i].hp; j++) {
					ctx.fillStyle = hpColor;
					ctx.fillRect(bottomX + hpWidth * j, bottomY, hpWidth, hpHeight);
					ctx.strokeStyle = "#000000";
					ctx.lineWidth = 1;
					ctx.strokeRect(bottomX, bottomY, HP * hpWidth, hpHeight);
				}
				
				// Draw kill count (temp / test)
				var killCount = ""+data.player[i].playerKills;
				ctx.fillText(killCount, otherX + 25, otherY - 5);
				
				// Draw player base and player top
				ctx.save()
				ctx.translate(otherX + PLAYER_SIZE/2, otherY + PLAYER_SIZE/2);
				ctx.rotate(data.player[i].directAngle * Math.PI/180);
				ctx.drawImage(Img.playerBase, -PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);
				ctx.restore();
				ctx.save();
				ctx.translate(otherX + PLAYER_SIZE/2, otherY + PLAYER_SIZE/2);
				ctx.rotate((data.player[i].mouseAngle + 90)* Math.PI/180);
				ctx.drawImage(Img.playerTop, -PLAYER_SIZE/2, -PLAYER_SIZE/2, PLAYER_SIZE, PLAYER_SIZE);
				ctx.restore();

			}
		}
	});
	
	document.onkeydown = function(event) {
		if(event.keyCode == 68 || event.keyCode == 39) {
			socket.emit('keyPress',{inputId:'right', state:true});
		}
		else if(event.keyCode == 65 || event.keyCode == 37) {
			socket.emit('keyPress',{inputId:'left', state:true});
		}
		
		else if(event.keyCode == 83 || event.keyCode == 40) {
			socket.emit('keyPress',{inputId:'down', state:true});
		}
		else if(event.keyCode == 87 || event.keyCode == 38) {
			socket.emit('keyPress',{inputId:'up', state:true});
		}
	}
	
	document.onkeyup = function(event) {
		if(event.keyCode == 68 || event.keyCode == 39) {
			socket.emit('keyPress',{inputId:'right', state:false});
		}
		else if(event.keyCode == 65 || event.keyCode == 37) {
			socket.emit('keyPress',{inputId:'left', state:false});
		}
		
		else if(event.keyCode == 83 || event.keyCode == 40) {
			socket.emit('keyPress',{inputId:'down', state:false});
		}
		else if(event.keyCode == 87 || event.keyCode == 38) {
			socket.emit('keyPress',{inputId:'up', state:false});
		}
	}
	
	ctx.canvas.onclick = function(event){
		socket.emit('keyPress',{inputId:'attack',state:true});
	}
	document.onblur = function(event){
		socket.emit('keyPress',{inputId:'lostFocus',state:true});
	}

	ctx.canvas.onmousemove = function(event){
		var x = event.clientX - (pOffsetX + ctx.canvas.offsetLeft);
		var y = event.clientY - (pOffsetY + ctx.canvas.offsetTop);
		var angle = Math.atan2(y,x) / Math.PI * 180;
		socket.emit('keyPress',{inputId:'mouseAngle',state:angle});

	}
	
</script>
</html>