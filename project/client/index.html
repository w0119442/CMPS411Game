<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="/css/buttonStyles.css" /> 
</head>

<body>
	<div id="themeDiv">
		<button id="tankTheme">Tank</button>
		<button id="bookTheme">Book</button>
		<button id="spiderTheme">Spider</button>
		<button id="ufoTheme">UFO</button>
		<button id="octopusTheme">Octopus</button>		
	</div>
	
	<canvas id="ctx"></canvas>
	<canvas id="worldMap" width="3000" height="3000" style="display:none;"></canvas>
	
	<script src="https://cdn.socket.io/socket.io-1.4.8.js"></script>
</body>

<script>

	var BUTTON_HEIGHT = 35;
	var WORLD_WIDTH = 1000;
	var WORLD_HEIGHT = 1000;
	var MAP_WRAP_NUMBER = 3;
	var BORDER_SIZE = 32;
	var PLAYER_SIZE = 50;
	var HP = 3;
	
	// Alter Viewport so the border fits nicely
	window.addEventListener("resize", resizeFunction);
	var clientWidth = window.innerWidth;
	var clientHeight = window.innerHeight;
	var VIEW_WIDTH = Math.floor(clientWidth * .9 / BORDER_SIZE) * BORDER_SIZE;
	var VIEW_HEIGHT = Math.floor(clientHeight * .9 / BORDER_SIZE) * BORDER_SIZE;
	
	var PLAYER_LIST = {};
	var socket = io();

	// theme selections
	var themeDiv = document.getElementById('themeDiv');
	var tankTheme = document.getElementById('tankTheme');
	
	var Img = {};
	Img.playerTop = new Image();
	Img.playerBase = new Image();
	Img.projectile = new Image();
	Img.map = new Image();
	Img.bgtile = new Image();
	
	var Snd = {};
	Snd.bgm = new Audio();
	Snd.bgm.loop = true;
	Snd.bgm.volume = 0.5;
	Snd.shoot = new Audio();
//	Snd.death = new Audio();
	
	// Set default theme to Tank 
	Img.playerTop.src = '/client/theme/Tank/playerTop.png';
	Img.playerBase.src = '/client/theme/Tank/playerBase.png';
	Img.projectile.src = '/client/theme/Tank/bullet.png';
	Img.map.src = '/client/theme/Tank/map.png';
	Img.bgtile.src = '/client/theme/Tank/bgtile.png';
	
	Snd.bgm.src = '/client/theme/Tank/bgm.mp3';
	Snd.bgm.play(); // play background music
	Snd.shoot.src = '/client/theme/Tank/bullet.mp3';
//	Snd.death.src = '/client/theme/Tank/death.mp3';
	
	var hpColorY = "#00FF99";
	var hpColorN = "#FF0000";
	var hpLine = "#000000";
	
	tankTheme.onclick = function() {
		setTheme("Tank");
	}
	bookTheme.onclick = function() {
		setTheme("Book");
	}
	spiderTheme.onclick = function() {
		setTheme("Spider");
	}
	ufoTheme.onclick = function() {
		setTheme("UFO");
	}	
	octopusTheme.onclick = function() {
		setTheme("Octopus");
	}		
	
	// Set up world map
	var worldMapCanvas = document.getElementById("worldMap");
	var worldMap = worldMapCanvas.getContext("2d");
	Img.map.onload = function() {
		var patrn = worldMap.createPattern(Img.map, "repeat");
		worldMap.fillStyle = patrn;
		worldMap.fillRect(0, 0, worldMapCanvas.width, worldMapCanvas.height);
	}
	
	// Set up game area (viewport)
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.canvas.width = VIEW_WIDTH;
	ctx.canvas.height = VIEW_HEIGHT;
	ctx.font = '30px Arial';
	
	Img.bgtile.onload = function() {
		var patrnBack = ctx.createPattern(Img.bgtile, "repeat");
		ctx.fillStyle = patrnBack;
		ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	}
	// These next two lines were an attempt to center the viewPort in the browser (not working)
	//ctx.canvas.style.top = (clientHeight-VIEW_HEIGHT)/2+"px";
	//ctx.canvas.style.left = (clientWidth-VIEW_WIDTH)/2+"px";
	
	var clientId = null;
	
	socket.on('init',function(data) {
		if(data.selfId) {
			clientId = data.selfId;
		}
	});
	
	var pCenterX = 0.0;
	var pCenterY = 0.0;
	var pOffsetX = 0.0;
	var pOffsetY = 0.0;
	
	socket.on('newPositions',function(data) {
		console.log(data);
		ctx.clearRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
		var patrnBack = ctx.createPattern(Img.bgtile, "repeat");
		ctx.fillStyle = patrnBack;
		ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	
		var playerTeam = data.player[clientId].team;
		var playerX = data.player[clientId].x;
		var playerY = data.player[clientId].y;
		var xPosImage = 0.0;
		var yPosImage = 0.0;
		var clipX = pCenterX - VIEW_WIDTH/2;
		var clipY = pCenterY - VIEW_HEIGHT/2;
		
		pCenterX = playerX + PLAYER_SIZE/2;
		pCenterY = playerY + PLAYER_SIZE/2;				
		pOffsetX = VIEW_WIDTH/2;
		pOffsetY = VIEW_HEIGHT/2;
		
		if(pCenterX  < VIEW_WIDTH/2) {
			clipX = 0;
			xPosImage = Math.min(BORDER_SIZE, Math.abs(VIEW_WIDTH/2 - pCenterX));
			pOffsetX = pCenterX + xPosImage;
		}
		else if(pCenterX  > WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH/2) {
			var borderSpot = WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH/2;
			clipX = WORLD_WIDTH * MAP_WRAP_NUMBER - VIEW_WIDTH + Math.min(BORDER_SIZE, Math.abs(borderSpot - pCenterX));
			pOffsetX = VIEW_WIDTH - (WORLD_WIDTH * MAP_WRAP_NUMBER - pCenterX) - Math.min(BORDER_SIZE, Math.abs(borderSpot - pCenterX));
			xPosImage = 0;
		}
		
		if(pCenterY  < VIEW_HEIGHT/2) {
			clipY = 0;
			yPosImage = Math.min(32, Math.abs(VIEW_HEIGHT/2 - pCenterY));					
			pOffsetY = pCenterY + yPosImage;
		}
		else if(pCenterY  > WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT/2) {
			var borderSpot = WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT/2;
			clipY = WORLD_HEIGHT * MAP_WRAP_NUMBER - VIEW_HEIGHT + Math.min(BORDER_SIZE, Math.abs(borderSpot - pCenterY));
			pOffsetY = VIEW_HEIGHT - (WORLD_HEIGHT * MAP_WRAP_NUMBER - pCenterY) - Math.min(BORDER_SIZE, Math.abs(borderSpot - pCenterY));
			yPosImage = 0;
		}

		//drawImage(image, clipX, clipY, clipWidth, clipHeight, xPos, yPos, imageWidth, imageHeight)
		ctx.drawImage(worldMapCanvas, clipX, clipY, VIEW_WIDTH, VIEW_HEIGHT, xPosImage, yPosImage, VIEW_WIDTH, VIEW_HEIGHT);
		
		for(var i = 0; i < data.projectile.length; i++) {
			var projX = data.projectile[i].x - pCenterX + pOffsetX - 5;
			var projY = data.projectile[i].y - pCenterY + pOffsetY - 5;
			ctx.drawImage(Img.projectile, projX, projY, 10, 10);
		}

		for(var i in data.player) {
			if(i == clientId && data.player[i].alive) {
				var bottomX = pOffsetX - PLAYER_SIZE/2;
				var bottomY = pOffsetY + PLAYER_SIZE/2;
				drawHP(bottomX, bottomY, playerTeam, data.player[i]);
				
				// Draw kill count (temp / test)
				var killCount = ""+data.player[i].playerKills;
				ctx.fillText(killCount, pOffsetX + 25, pOffsetY -5);
			
				// Draw the player base and player top
				drawPlayer(pOffsetX, pOffsetY, data.player[i].directAngle, Img.playerBase, PLAYER_SIZE);
				drawPlayer(pOffsetX, pOffsetY, data.player[i].mouseAngle, Img.playerTop, PLAYER_SIZE);
			}
			else if(Math.abs(pCenterX - data.player[i].x) < VIEW_WIDTH && Math.abs(pCenterY - data.player[i].y) < VIEW_HEIGHT && data.player[i].alive) {
				var otherX = data.player[i].x - pCenterX + pOffsetX;
				var otherY = data.player[i].y - pCenterY + pOffsetY;
				drawHP(otherX, otherY + PLAYER_SIZE, playerTeam, data.player[i]);
				
				// Draw kill count (temp / test)
				var killCount = ""+data.player[i].playerKills;
				ctx.fillText(killCount, otherX + 25, otherY - 5);
				
				// Draw player base and player top
				drawPlayer(otherX + PLAYER_SIZE/2, otherY + PLAYER_SIZE/2, data.player[i].directAngle, Img.playerBase, PLAYER_SIZE);
				drawPlayer(otherX + PLAYER_SIZE/2, otherY + PLAYER_SIZE/2, data.player[i].mouseAngle, Img.playerTop, PLAYER_SIZE);
			}
		}
	});
	
	document.onkeydown = function(event) {
		if(event.keyCode == 68 || event.keyCode == 39) {
			socket.emit('keyPress',{inputId:'right', state:true});
		}
		else if(event.keyCode == 65 || event.keyCode == 37) {
			socket.emit('keyPress',{inputId:'left', state:true});
		}
		
		else if(event.keyCode == 83 || event.keyCode == 40) {
			socket.emit('keyPress',{inputId:'down', state:true});
		}
		else if(event.keyCode == 87 || event.keyCode == 38) {
			socket.emit('keyPress',{inputId:'up', state:true});
		}
	}
	
	document.onkeyup = function(event) {
		if(event.keyCode == 68 || event.keyCode == 39) {
			socket.emit('keyPress',{inputId:'right', state:false});
		}
		else if(event.keyCode == 65 || event.keyCode == 37) {
			socket.emit('keyPress',{inputId:'left', state:false});
		}
		
		else if(event.keyCode == 83 || event.keyCode == 40) {
			socket.emit('keyPress',{inputId:'down', state:false});
		}
		else if(event.keyCode == 87 || event.keyCode == 38) {
			socket.emit('keyPress',{inputId:'up', state:false});
		}
	}
	
	ctx.canvas.onclick = function(event){
		socket.emit('keyPress',{inputId:'attack',state:true});
		Snd.shoot.currentTime = 0;
		Snd.shoot.play();
	}
	document.onblur = function(event){
		socket.emit('keyPress',{inputId:'lostFocus',state:true});
	}

	ctx.canvas.onmousemove = function(event){
		var x = event.clientX - (pOffsetX + ctx.canvas.offsetLeft);
		var y = event.clientY - (pOffsetY + ctx.canvas.offsetTop);
		var angle = Math.atan2(y,x)/ Math.PI * 180;
		socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
	}
	
	// Function for drawing player images (base and top)
	function drawPlayer(transX, transY, angle, pImage, pSize) {
		ctx.save();
		ctx.translate(transX, transY);
		ctx.rotate((angle + 90) * Math.PI/180);
		ctx.drawImage(pImage, -pSize/2, -pSize/2, pSize, pSize);
		ctx.restore();	
	}
	
	// Function for drawing the hp bar
	function drawHP(botX, botY, team, p) {
		var hpHeight = 7;
		var hpWidth = Math.floor(PLAYER_SIZE/HP);

		for(var j = 0; j < p.hp; j++) {
			if(p.team == team) {
				ctx.fillStyle = hpColorY;
			}
			else {
				ctx.fillStyle = hpColorN;
			}
			ctx.fillRect(botX + hpWidth * j, botY, hpWidth, hpHeight);
		}
		
		ctx.strokeStyle = hpLine;
		ctx.lineWidth = 1;
		ctx.strokeRect(botX, botY, HP * hpWidth, hpHeight);
	}
	
	// On screen resize, variables are recomputed
	function resizeFunction() {
		clientWidth = window.innerWidth;
		clientHeight = window.innerHeight;
		VIEW_WIDTH = Math.floor(clientWidth * .9 / BORDER_SIZE) * BORDER_SIZE;
		VIEW_HEIGHT = Math.floor(clientHeight * .9 / BORDER_SIZE) * BORDER_SIZE;
		ctx.canvas.width = VIEW_WIDTH;
		ctx.canvas.height = VIEW_HEIGHT;
		ctx.font = '30px Arial';
		var patrnBack = ctx.createPattern(Img.bgtile, "repeat");
		ctx.fillStyle = patrnBack;
		ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	}
	
	// Function that sets the theme based on the button clicked
	function setTheme(theme) {
		Img.playerTop.src = "/client/theme/" + theme + "/playerTop.png";
		Img.playerBase.src = "/client/theme/" + theme + "/playerBase.png";
		Img.projectile.src = "/client/theme/" + theme + "/bullet.png";
		Img.map.src = "/client/theme/" + theme + "/map.png";
		Img.bgtile.src = "/client/theme/" + theme + "/bgtile.png";
		Snd.bgm.src = "/client/theme/" + theme + "/bgm.mp3";
		Snd.shoot.src = "/client/theme/" + theme + "/bullet.mp3";
//		Snd.death.src = "/client/theme/" + theme + "/death.mp3";
		Snd.bgm.load();
		Snd.shoot.load();
//		Snd.death.load();
		Snd.bgm.play();
		
		switch(theme)
		{
			case "UFO":
				hpColorY = "#F7BE81";
				hpColorN = "#4B088A";
				hpLine = "#FFFFFF";
				break;
			case "Book":
				hpColorY = "#2EFEC8";
				hpColorN = "#B4045F";
				hpLine = "#0A0A2A";
				break;			
			case "Octopus":
				hpColorY = "#A9F5BC";
				hpColorN = "#DF013A";
				hpLine = "#86B404";
				break;					
			default:
			 	hpColorY = "#00FF99";
				hpColorN = "#FF0000";
				hpLine = "#000000";
		}
	}
	
</script>
</html>